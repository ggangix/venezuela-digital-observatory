name: Check Domain Status

on:
  schedule:
    - cron: '0 0,8,16 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download status.json from server
        run: |
          HTTP_CODE=$(curl -sL -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: application/json" \
            --retry 3 \
            --retry-delay 5 \
            "https://raw.macedoniadelnorte.com/monitor/status.json" \
            -o monitor/status.json)

          echo "HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Server returned HTTP $HTTP_CODE"
            echo "First 500 chars of response:"
            head -c 500 monitor/status.json
            exit 1
          fi

      - name: Validate JSON
        run: |
          if ! jq empty monitor/status.json 2>/dev/null; then
            echo "Error: Downloaded file is not valid JSON"
            echo "First 500 chars of file:"
            head -c 500 monitor/status.json
            exit 1
          fi
          echo "JSON validation passed"
          echo "Domains count: $(jq '.domains | length' monitor/status.json)"

      - name: Commit status.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add monitor/status.json
          git diff --staged --quiet || git commit -m "status: update $(date -u +%Y-%m-%d)"
          git push
